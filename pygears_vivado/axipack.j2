{%- import 'snippet.j2' as snippet -%}

{{ snippet.prjgen("ipgen", prjdir, files=files, top=wrap_name) }}

{{ snippet.ip_inst("dtidma", "axi_dma", ipdir=os.path.join(prjdir, "ipgen.srcs", "sources_1", "ip"), params=dma_params) }}

ipx::package_project -import_files -root_dir {{ipdir}}

set_property name {{ip_name}} [ipx::current_core]
set_property display_name {{ip_name}} [ipx::current_core]
set_property description {{description}} [ipx::current_core]
set_property taxonomy /AXI_Infrastructure [ipx::current_core]
set_property supported_families {zynq Production zynquplus Production artix7 Production kintex7 Production kintexu Production} [ipx::current_core]

ipx::add_file_group -type software_driver {} [ipx::current_core]

{% for f in drv_files %}
ipx::add_file {{f}} [ipx::get_file_groups xilinx_softwaredriver -of_objects [ipx::current_core]]
set_property type {cSource driver_src} [ipx::get_files {{f}} -of_objects [ipx::get_file_groups xilinx_softwaredriver -of_objects [ipx::current_core]]]
{% endfor %}

ipx::add_file driver/{{ip_name}}_v1_0/data/{{ip_name}}.mdd [ipx::get_file_groups xilinx_softwaredriver -of_objects [ipx::current_core]]
set_property type {mdd driver_mdd} [ipx::get_files driver/{{ip_name}}_v1_0/data/{{ip_name}}.mdd -of_objects [ipx::get_file_groups xilinx_softwaredriver -of_objects [ipx::current_core]]]

ipx::add_file driver/{{ip_name}}_v1_0/data/{{ip_name}}.tcl [ipx::get_file_groups xilinx_softwaredriver -of_objects [ipx::current_core]]
set_property type {tclSource driver_tcl} [ipx::get_files driver/{{ip_name}}_v1_0/data/{{ip_name}}.tcl -of_objects [ipx::get_file_groups xilinx_softwaredriver -of_objects [ipx::current_core]]]

ipx::add_file driver/{{ip_name}}_v1_0/src/Makefile [ipx::get_file_groups xilinx_softwaredriver -of_objects [ipx::current_core]]
set_property type {driver_src} [ipx::get_files driver/{{ip_name}}_v1_0/src/Makefile -of_objects [ipx::get_file_groups xilinx_softwaredriver -of_objects [ipx::current_core]]]

ipx::add_user_parameter C_S_AXI_LITE_BASEADDR [ipx::current_core]
set_property value_resolve_type user [ipx::get_user_parameters C_S_AXI_LITE_BASEADDR -of_objects [ipx::current_core]]
ipgui::add_param -name {C_S_AXI_LITE_BASEADDR} -component [ipx::current_core]
set_property display_name {C S Axi Lite Baseaddr} [ipgui::get_guiparamspec -name "C_S_AXI_LITE_BASEADDR" -component [ipx::current_core] ]
set_property widget {hexEdit} [ipgui::get_guiparamspec -name "C_S_AXI_LITE_BASEADDR" -component [ipx::current_core] ]
set_property value 0xFFFFFFFFF [ipx::get_user_parameters C_S_AXI_LITE_BASEADDR -of_objects [ipx::current_core]]
set_property value_bit_string_length 32 [ipx::get_user_parameters C_S_AXI_LITE_BASEADDR -of_objects [ipx::current_core]]
set_property enablement_value false [ipx::get_user_parameters C_S_AXI_LITE_BASEADDR -of_objects [ipx::current_core]]
set_property value_format bitString [ipx::get_user_parameters C_S_AXI_LITE_BASEADDR -of_objects [ipx::current_core]]
ipx::add_user_parameter C_S_AXI_LITE_HIGHADDR [ipx::current_core]
set_property value_resolve_type user [ipx::get_user_parameters C_S_AXI_LITE_HIGHADDR -of_objects [ipx::current_core]]
ipgui::add_param -name {C_S_AXI_LITE_HIGHADDR} -component [ipx::current_core]
set_property display_name {C S Axi Lite Highaddr} [ipgui::get_guiparamspec -name "C_S_AXI_LITE_HIGHADDR" -component [ipx::current_core] ]
set_property widget {hexEdit} [ipgui::get_guiparamspec -name "C_S_AXI_LITE_HIGHADDR" -component [ipx::current_core] ]
set_property value 0x00000000 [ipx::get_user_parameters C_S_AXI_LITE_HIGHADDR -of_objects [ipx::current_core]]
set_property value_bit_string_length 32 [ipx::get_user_parameters C_S_AXI_LITE_HIGHADDR -of_objects [ipx::current_core]]
set_property enablement_value false [ipx::get_user_parameters C_S_AXI_LITE_HIGHADDR -of_objects [ipx::current_core]]
set_property value_format bitString [ipx::get_user_parameters C_S_AXI_LITE_HIGHADDR -of_objects [ipx::current_core]]

set base_param [ipx::add_address_block_parameter OFFSET_BASE_PARAM [ipx::get_address_blocks reg0 -of_objects [ipx::get_memory_maps s_axi_lite -of_objects [ipx::current_core]]]]
set_property value C_S_AXI_LITE_BASEADDR $base_param
set high_param [ipx::add_address_block_parameter OFFSET_HIGH_PARAM [ipx::get_address_blocks reg0 -of_objects [ipx::get_memory_maps s_axi_lite -of_objects [ipx::current_core]]]]
set_property value C_S_AXI_LITE_HIGHADDR $high_param

# Package IP
ipx::create_xgui_files [ipx::current_core]
ipx::update_checksums [ipx::current_core]
ipx::save_core [ipx::current_core]
